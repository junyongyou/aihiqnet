# PHIQnet Implementation

TF-Keras implementation of PHIQnet as described in [Perceptual Hierarchical Networks for No-Reference Image Quality Assessment] by Junyong You and Jari Korhonen.

## Installation

1) Clone this repository.
2) Install required Python packages. The code is developed by PyCharm in Python 3.7. The requirements.txt document is generated by PyCharm. Please note this is for running the models on an old 1080Ti GPU with TF version 2.2.
3) The models have actually been trained on RTX3090 by tf-nightly-gpu (version 2.6), and the latest version of code can be run under both TF2.2 and TF-nightly. I followed the guidance (https://www.reddit.com/r/tensorflow/comments/jsalkw/rtx_3090_and_tensorflow_for_windows_10_step_by/) to install TF on RTX3090.

## Training a model
Many examples of training PHIQnet and its variants can be seen in image_quality/bin.
Argparser should be used, but the authors prefer to use dictionary with parameters being defined. It is easy to convert to take arguments.
In principle, the following parameters can be defined:

    args = {}
    args['multi_gpu'] = 0 # gpu setting, set to 1 for using multiple GPUs
    args['gpu'] = 0  # If having multiple GPUs, specify which GPU to use

    args['result_folder'] = r'..\databases\experiments' # Define result path
    args['n_quality_levels'] = 5  # Choose between 1 (MOS prediction) and 5 (distribution prediction)

    args['train_folders'] =  # Define folders containing training images
        [
        r'..\databases\train\koniq_normal',
        r'..\databases\train\koniq_small',
        r'..\databases\train\live'
        ]
    args['val_folders'] =  # Define folders containing testing images
        [
        r'..\databases\val\koniq_normal',
        r'..\databases\val\koniq_small',
        r'..\databases\val\live'
        ]
    args['koniq_mos_file'] = r'..\databases\koniq10k_images_scores.csv'  # MOS (distribution of scores) file for KonIQ database
    args['live_mos_file'] = r'..\databases\live_mos.csv'   # MOS (standard distribution of scores) file for LIVE-wild database

    args['naive_backbone'] = False  # Choose between True and False, indicating using backbone network only or neck + head as well
    args['backbone'] = 'resnet50' # Choose from ['densenet121', resnet18', 'resnet50', 'resnet152', 'resnet152v2', 'vgg16', 'resnest50']
    args['weights'] = r'..\pretrained_weights\resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5'  # Define the path of ImageNet pretrained weights
    args['initial_epoch'] = 0  # Define initial epoch for use in fine-tune

    args['lr_base'] = 1e-4 / 2  # Define the back learning rate in warmup and rate decay approach
    args['lr_schedule'] = True  # Choose between True and False, indicating if learning rate schedule should be used or not
    args['batch_size'] = 16  # Batch size, should choose to fit in the GPU memory
    args['epochs'] = 100  # Maximal epoch number, can set early stop in the callback or not

    args['feature_fusion'] = True  # Choose between True and False, indicating if feature fusion should be used or not
    args['attention_module'] = True  # Choose between True and False, indicating if attention module should be used or not

    args['image_aug'] = True # Choose between True and False, indicating if image augmentation should be used or not

## Predict image quality using the trained model
After PHIQnet has been trained, and the weights have been stored in h5 file, it can be used to predict image quality with arbitrary sizes,

```shell
    args = {}
    args['n_quality_levels'] = 5
    args['naive_backbone'] = False
    args['backbone'] = 'resnet50'
    args['feature_fusion'] = True
    args['weights'] = 'phiqnet.h5'
    model = phiq_net(n_quality_levels=args['n_quality_levels'],
                     naive_backbone=args['naive_backbone'],
                     backbone=args['backbone'],
                     feature_fusion=args['feature_fusion'])
    model.load_weights(args['weights'])
```
And then use ModelEvaluation to predict quality of imageset.

## Prepare datasets for model training
This work uses two publicly available databases: KonIQ-10k [KonIQ-10k: An ecologically valid database for deep learning of blind image quality assessment](https://ieeexplore.ieee.org/document/8968750) by V. Hosu, H. Lin, T. Sziranyi, and D. Saupe;
 and LIVE-wild [Perceptual quality assessment of smartphone photography](https://openaccess.thecvf.com/content_CVPR_2020/html/Fang_Perceptual_Quality_Assessment_of_Smartphone_Photography_CVPR_2020_paper.html) by Y. Fang, H. Zhu, Y. Zeng, K. Ma, and Z. Wang.

1) The two databases were merged, and then split to training and testing sets. Please see README in image_quality/databases for details.
2) Make MOS files (note: do NOT include head line):

    For database with score distribution available, the MOS file is like this (koniq format):
    ```
        image path, voter number of quality scale 1, voter number of quality scale 2, voter number of quality scale 3, voter number of quality scale 4, voter number of quality scale 5, MOS or Z-score
        10004473376.jpg,0,0,25,73,7,3.828571429
        10007357496.jpg,0,3,45,47,1,3.479166667
        10007903636.jpg,1,0,20,73,2,3.78125
        10009096245.jpg,0,0,21,75,13,3.926605505
    ```

    For database with standard deviation available, the MOS file is like this (live format):
    ```
        image path, standard deviation, MOS or Z-score
        t1.bmp,18.3762,63.9634
        t2.bmp,13.6514,25.3353
        t3.bmp,18.9246,48.9366
        t4.bmp,18.2414,35.8863
    ```

    The format of MOS file ('koniq' or 'live') and the format of MOS or Z-score ('mos' or 'z_score') should also be specified in image_quality/misc/imageset_handler/get_image_scores.
3) In the train script in image_quality/bin, the folders containing training and testing images are provided.
4) Pretrained ImageNet weights can be downloaded (see README in image_quality/pretrained_weights) and pointed to in the train script in image_quality/bin.

## Report bugs
Please check the paths of image, weights, etc. first if encountering any problems. Please report any bugs in Issues. 

## FAQs
* To be added
